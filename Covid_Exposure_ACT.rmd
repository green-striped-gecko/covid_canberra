---
title: "Covid19 exposure locations in the ACT"
resource_files:
- data/last.csv
#runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
params:
    lup: "unknown"
---

```{r setup, include=TRUE}
library(tidyverse)
library(ggmap)
library(leaflet)
library(plotly)
library(flexdashboard)
library(DT)
library(crosstalk)
#latest dataset
tab3 <- read.csv("data/last.csv")
# Aggregate method
cols <-c("yellow", "red", "blue")

cc <- as.numeric(factor(tab3$Contact))

labs <- paste(tab3$Contact, tab3$Status,tab3$Exposure.Location, tab3$Street, tab3$Suburb, tab3$Date,tab3$Arrival.Time, tab3$Departure.Time, tab3$doubles, sep="<br/>") 

###############################################
##plot the map



m <- leaflet() %>% addTiles()

m <- m %>% addCircleMarkers(lat=tab3$lat, lng=tab3$lon,popup = labs, weight=0.5, color = cols[cc], radius = 5 , fillOpacity = 0.8) %>% addCircleMarkers(lat=tab3$lat, lng=tab3$lon,popup = labs, weight=0.5, color = cols[cc], radius = 5 , fillOpacity = 0.8
  #                                                                                                                                                       , clusterOptions =  
  #                             markerClusterOptions(iconCreateFunction=JS("function (cluster) {    
  #   var childCount = cluster.getChildCount();  
  #   if (childCount < 100) {  
  #     c = 'rgba(64, 64, 64, 0.3);'
  #   } else if (childCount < 1000) {  
  #     c = 'rgba(64, 64, 64, 0.3);'  
  #   } else { 
  #     c = 'rgba(64, 64, 64, 0.3);'  
  #   }    
  #   return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', className: 'marker-cluster', iconSize: new L.Point(40, 40) });
  # 
  # }")    )
)
```

```{r title, results='asis'} 

cat(paste0("# ", params$lup))

```

<sup>Disclaimer: This map shows the covid exposure locations in the ACT and is an **unofficial website** based on [official sources](https://www.covid19.act.gov.au/act-status-and-response/act-covid-19-exposure-locations). So if in doubt, refer to the [offical website](https://www.covid19.act.gov.au/act-status-and-response/act-covid-19-exposure-locations), which has now also an [**official map**](https://www.covid19.act.gov.au/act-status-and-response/act-covid-19-exposure-locations/map#Map-of-ACT-exposure-locations) included. Supported by Volunteers from the University of Canberra. Contacts: Bernd Gruber [bernd.gruber@canberra.edu.au] & Anthony Davidson [anthony.davidson@canberra.edu.au]</sup>

Column {data-width=450}
-----------------------------------------------------------------------

### Map of Exposure sites

```{r}
library(sparkline)
#checks 
# m
library(crosstalk)

#latest dataset
tab3 <- read_csv(here::here("data/last.csv"))

# Aggregate method
cols <-c("yellow", "red", "blue")

cc <- as.numeric(factor(tab3$Contact))

labs <- paste(tab3$Contact, tab3$Status,tab3$Exposure.Location, tab3$Street, tab3$Suburb, tab3$Date,tab3$Arrival.Time, tab3$Departure.Time, tab3$doubles, sep="<br/>") 

length(unique(tab3$Suburb))
names(tab3)
# generally speaking, use a "unique" key for filter, 
# especially when you have multiple filters!
tx <- highlight_key(tab3)

gg <- ggplot(tx) + geom_point(aes(Date, Contact, group = Contact, colour = Contact))

filter <- bscols(
  filter_select("Suburb", "Select a suburb", tx, ~Suburb),
  ggplotly(gg, dynamicTicks = TRUE),
  widths = c(6, 6)
)

tx2 <- highlight_key(tab3, ~Contact, "Select a level")

gg <- ggplot(tx2) + geom_histogram(aes(Contact, group = Suburb), stat = "count")
select <- highlight(
  ggplotly(gg, tooltip = "Suburb"), 
  selectize = FALSE, persistent = TRUE
)

bscols(filter, select)

```

<!-- Column {data-width=350} -->
<!-- ----------------------------------------------------------------------- -->
<!-- ### Sparkline -->

<!-- ```{r} -->
<!-- library(htmlwidgets) -->
<!-- library(sparkline) -->
<!-- set.seed(1234) -->
<!-- x = rnorm(10) -->
<!-- y = rnorm(10) -->
<!-- sparkline(abs(x), type = 'bar', height = 50, width = 100) -->
<!-- ``` -->


<!-- - Inline line graphs `r #sparkline(x)` -->

<!-- - bar charts  `r #sparkline(abs(x), type = 'bar')`   -->

<!-- - negative values: `r #sparkline(x, type = 'bar')` -->

<!-- - sizing inline `r #sparkline(abs(x), type = 'bar', height = 50, width = 100)` -->

<!-- ### Table -->

<!-- ```{r eval = FALSE} -->
<!-- library(DT) -->
<!-- dtt <-DT::datatable(tab3[,c(1,8,2:7)], -->
<!--   rownames = FALSE, options = list(pageLength = 50, ausoHideNavigation=TRUE,  -->
<!--   initComplete = JS( -->
<!--         "function(settings, json) {", -->
<!--         "$(this.api().table().header()).css({'font-size': '50%'});", -->

<!--         "}")))  %>% DT::formatStyle(columns = 1:8, fontSize='70%')  -->

<!-- dtt -->

<!-- ``` -->

<!-- <!-- ### Dynamic timeline --> -->

<!-- <!-- ```{r include = FALSE} --> -->
<!-- <!-- names(tab3) --> -->
<!-- <!-- glimpse(tab3) --> -->

<!-- <!-- countSub <- as.data.frame(table(as.factor(tab3$Suburb))) --> -->
<!-- <!-- names(countSub) <- c("Suburb", "Total Count") --> -->


<!-- <!-- # ggplot(countSub) + --> -->
<!-- <!-- #   geom_point(aes(x = Var1, y = Freq, col = Status)) --> -->


<!-- <!-- locs <- select(tab3, lat, lon, Suburb) --> -->

<!-- <!-- plotdat1 <- left_join(countSub, tab3, by = "Suburb") --> -->

<!-- <!-- # length(unique(as.factor(tab3$Suburb))) --> -->
<!-- <!-- tab4 <- tab3 %>% --> -->
<!-- <!--   group_by(Suburb) %>% --> -->
<!-- <!--     summarise(count = length(as.factor(Suburb)), --> -->
<!-- <!--               lat = mean(lat), --> -->
<!-- <!--               lon = mean(lon)) --> -->

<!-- <!-- tab5 <- tab4 %>% --> -->
<!-- <!-- group_by(count)%>% --> -->
<!-- <!--       arrange(desc = TRUE, .by_group = TRUE) --> -->

<!-- <!--               # , --> -->

<!-- <!-- # glimpse(tab4) --> -->
<!-- <!-- # glimpse(plotdat1) --> -->
<!-- <!-- #filter on location --> -->

<!-- <!-- # ggplot(tab5) + --> -->
<!-- <!-- #   geom_point(aes(x = Suburb, y = count), size = 3) + --> -->
<!-- <!-- #   theme(axis.text.x = element_text(angle = 90)) --> -->
<!-- <!-- ``` --> -->

<!-- Column {data-width=50} -->
<!-- ----------------------------------------------------------- -->
<!-- ### Info -->

<!-- Extracted from the ACT goverment website at `r Sys.time()`. This application is intended to make finding and understanding contact locations easier in the ACT.  -->

<!-- ### New CLOSE contacts  -->

<!-- `r Sys.Date()`<!-- Checked at 17082021 -->  -->

<!-- ```{r} -->
<!-- articles <- table(tab3$Status)[2]#computeArticles() -->
<!-- valueBox(articles, icon = "fa-pencil") -->
<!-- ``` -->

<!-- ### CASUAL contacts `r #sparkline(x)` -->

<!-- ```{r} -->
<!-- articles <- table(tab3$Status)[2]#computeArticles() -->
<!-- valueBox(articles, icon = "fa-pencil") -->
<!-- ``` -->


<!-- https://covid19nearme.com.au/state/act -->



